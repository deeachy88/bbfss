<!DOCTYPE html>
{% load static %}
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6 lt8"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7 lt8"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8 lt8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->

    <head>
        <meta charset="UTF-8" />
        <!-- <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">  -->
        <title>Login</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Login and Registration Form with HTML5 and CSS3" />
        <meta name="keywords" content="html5, css3, form, switch, animation, :target, pseudo-class" />
        <meta name="author" content="Codrops" />
        <link rel="shortcut icon" href="../favicon.ico">
        <link rel="stylesheet" type="text/css" href="{% static 'css/demo.css' %}" />
        <link rel="stylesheet" type="text/css" href="{% static 'css/style2.css' %}" />
		<link rel="stylesheet" type="text/css" href="{% static 'css/animate-custom.css' %}" />
        <style>
              hr {
                  margin-top: 1rem;
                  margin-bottom: 1rem;
                  border: 0;
                  border-top: 1px solid #33a661;
                  margin-right: 0px;
              }
              ::placeholder { /* Chrome, Firefox, Opera, Safari 10.1+ */
                color: black;
                opacity: 1; /* Firefox */
              }
              #wrapper select
              {
                    width: 98%;
                    margin-top: 2px;
                    padding: 10px 5px 10px 2px;
                    border: 1px solid rgb(178, 178, 178);
                    -webkit-appearance: textfield;
                    -webkit-box-sizing: content-box;
                    -moz-box-sizing: content-box;
                    box-sizing: content-box;
                    -webkit-border-radius: 3px;
                    -moz-border-radius: 3px;
                    border-radius: 3px;
                    -webkit-box-shadow: 0px 1px 4px 0px rgb(168 168 168 / 60%) inset;
                    -moz-box-shadow: 0px 1px 4px 0px rgba(168, 168, 168, 0.6) inset;
                    box-shadow: 0px 1px 4px 0px rgb(168 168 168 / 60%) inset;
                    -webkit-transition: all 0.2s linear;
                    -moz-transition: all 0.2s linear;
                    -o-transition: all 0.2s linear;
                    transition: all 0.2s linear;
              }
              .alert {
                  padding: 10px;
                  background-color: #f44336;
                  color: white;
                }
                .footer
                {
                    margin-top: 350px;
                    border-top: 1px solid #33a661;
                    padding: 1rem 1rem 1rem;
                    color: #000;
                    background-color: #327e24;
                }
        </style>
    </head>
    <body style="background:url(static/assets/img/background1.jpg) no-repeat center;background-size:max-width:100%">
        <div class="container">
            <header>
                <img src="{% static 'assets/img/banner.png' %}" class="img-fluid mx-auto d-block" alt="Responsive image" style="background:center;max-width:100%">
                <nav class="codrops-demos">
					<a href="{% url 'apply_complaint_form' %}" class="btn btn-sm btn-info">
                        <i class="fa fa-comments-o"></i>
                        Complaint
                    </a>
                    <a href="{% static '/assets/manual/BBFS_UserManual.pdf' %}" class="btn btn-sm btn-danger" download="{% static 'assets/manual/BBFS_UserManual.pdf' %}">
                        <i class="fa fa-cloud-download"></i>
                        User Manual
                    </a>
				</nav>
            </header>
            <hr>
            <section>
                <div id="container_demo">
                    <!-- hidden anchor to stop jump http://www.css3create.com/Astuce-Empecher-le-scroll-avec-l-utilisation-de-target#wrap4  -->
                    <a class="hiddenanchor" id="toregister"></a>
                    <a class="hiddenanchor" id="tologin"></a>
                    <div id="wrapper">
                        <div id="login" class="animate form">
                            <form action="{% url 'login' %}" id="loginForm" method="post">
                                {% csrf_token %}
                                <h1>Log in</h1>
                                {% if message %}
                                    <div class="alert alert-danger" id="login_error">{{ message }}</div>
                                {% endif %}
                                <p>
                                    <label for="emailsignup" class="youmail" data-icon="e"> Your Email</label>
                                    <input id="emailsignup" name="username" required="required" type="email" >
                                </p>
                                <p>
                                    <label for="password" class="youpasswd" data-icon="p"> Your Password </label>
                                    <input id="password" name="password" required="required" type="password" />
                                </p>
                                <p class="login button">
                                    <input type="submit" value="Login" />
								</p>
                                <p class="change_link">
									<a href="{% url 'register' %}" class="to_register">Client Register</a>
									<a href="#toregister" class="to_register">Forgot Password ?</a>
								</p>
                            </form>
                        </div>
                        <div id="register" class="animate form">
                            <form method="post" id="forgot_password_form">
                                {% csrf_token %}
                                <h1> Forgot Password </h1>
                                <p>
                                    <div class="form-group">
                                        <label for="email" class="uname" data-icon="e">Your Email</label>
                                        <input name="email" id="email" required="required" type="text" onchange="validateemailId(this.value)" onblur="getSecurityQuestion(this.value)"/>
                                    </div>
                                    <div class="alert" id="emailErrorMsg" style="display:none"></div>
                                </p>
                                <p>
                                    <div class="form-group">
                                        <label for="security" class="youpasswd" >Security Question </label>
                                        <select name="security" id="security" onchange="getAnswer(this.value)">
                                            <option value="">SELECT SECURITY QUESTION</option>
                                            {% for security in security %}
                                                <option value="{{ security.Question_Id }}">{{ security.Question }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="alert" id="securityErrorMsg" style="display:none"></div>
                                </p>
                                <p>
                                    <div class="form-group">
                                        <label for="answer" class="youpasswd" data-icon="A">Security Answer</label>
                                        <input id="answer" name="answer" required="required" type="text" />
                                        <input type="hidden" class="form-control form-control-md" id="securityAnswer">
                                    </div>
                                    <div class="alert" id="AnswerErrorMsg" style="display:none"></div>
                                </p>
                                <div id="sucessMsg" class="alert alert-info" role="alert" style="display:none;">
                                    Your password was successfully reset..Please Check Your Email
                                </div>
                                <p class="signin button">
									<input type="button" id="submit_button" value="Submit"  onclick="update_password()"/>
								</p>
                                <p class="change_link">
									Already a member ?
									<a href="#tologin" class="to_register"> Go and log in </a>
								</p>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
            <div class="text-center">
              <p class="footer">Â©  BAFRA- Bhutan Biosecurity and Food Safety System (BBFSS), 2021. All Rights Reserved.</p>
            </div>
        </div>
    </body>
</html>
<script src="{% static 'styles/jquery/dist/jquery.min.js' %}"></script>
<script>
var spinner = $('#loader');
spinner.hide();
function saveDetails()
{
    var new_password = $('#new_password').val();
    var confirm_password = $('#confirm_password').val();
    var pattern = /(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}/;
    var no = new_password.match(pattern);
    var security_question = $('#security_question').val();
    var answer = $('#Answer').val();

        if(new_password == "")
            {
                $('#new_passwordErrorMsg').html("");
                $('#new_passwordErrorMsg').html("New Password Cannot Be Empty");
                $('#new_passwordErrorMsg').show();
                $('#new_passwordErrorMsg').delay(2000).fadeOut('slow');
                return;
            }
        if(no==null)
            {
                $('#new_passwordErrorMsg').html("");
                $('#new_passwordErrorMsg').html("Must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters");
                $('#new_passwordErrorMsg').show();
                $('#new_passwordErrorMsg').delay(2000).fadeOut('slow');
                return;
            }
        if(confirm_password == "")
            {
                $('#confirm_passworderrorMsg').html("");
                $('#confirm_passworderrorMsg').html("Confirm Password Cannot Be Empty");
                $('#confirm_passworderrorMsg').show();
                $('#confirm_passworderrorMsg').delay(2000).fadeOut('slow');
                return;
            }
        if(new_password != confirm_password)
            {
                $('#confirm_passworderrorMsg').html("");
                $('#confirm_passworderrorMsg').html("New password and Password Confirmation Does Not Match");
                $('#confirm_passworderrorMsg').show();
                $('#confirm_passworderrorMsg').delay(2000).fadeOut('slow');
                $('#new_password').val("");
                $('#confirm_password').val("");
                $('#security_question').val("");
                $('#Answer').val("");
                return;
            }
        if(security_question == "")
            {
                $('#security_questionerrorMsg').html("");
                $('#security_questionerrorMsg').html("Select Atleast One Security Question");
                $('#security_questionerrorMsg').show();
                $('#security_questionerrorMsg').delay(2000).fadeOut('slow');
                return;
            }
        if(answer == "")
            {
                $('#AnswererrorMsg').html("");
                $('#AnswererrorMsg').html("security answer cannot be empty");
                $('#AnswererrorMsg').show();
                $('#AnswererrorMsg').delay(2000).fadeOut('slow');
                return;
            }
        else
            {
                $.ajax({
                    type : "POST",
                    url : "{% url 'password_update' %}",
                    data : $('#passwordUpdateForm').serialize(),
                    cache : false,
                    dataType : "html",
                    success : function(responseText)
                    {
                        $('#update_passwordMsg').show();
                        $('#update_passwordMsg').delay(2000).fadeOut('slow');
                        setTimeout('redirectPage()',2000);
                    }
                });
            }
}

function redirectPage()
{
    var url = "{% url 'login' %}";
    document.forms[0].action = url;
    document.forms[0].submit();
}

function getGewog(dzongkhag_id)
{
    $.ajax({
        type : "GET",
        url : "{% url 'load_gewog' %}",
        data :{'dzongkhag_id':dzongkhag_id},
        success : function(data) {
            $('#gewog').html(data);
        }
    });
}

function getVillage(gewog_id)
{
    $.ajax({
        type : "GET",
        url : "{% url 'load_village' %}",
        data :{'gewog_id':gewog_id},
        success : function(data) {
            $('#village').html(data);
        }
    });
}

function getRegistrationForm()
{
    $.ajax({
        type : "GET",
        url : "{% url 'register' %}",
        success : function(data) {
            $('#regDiv').html(data);
        }
    });
}

function update_password()
    {

        var uid = $('#email').val();
        var answer = $('#answer').val();
        var security = $('#security').val();
        var answerForm =  $('#securityAnswer').val();

        if(uid == "")
        {
            $('#emailErrorMsg').html("Email Is Required");
            $('#emailErrorMsg').show();
            $('#email').focus();
            $('#emailErrorMsg').delay(2000).fadeOut('slow');
        }
        else if(security == "")
        {
            $('#securityErrorMsg').html("Select Security Question");
            $('#securityErrorMsg').show();
            $('#security').focus();
            $('#securityErrorMsg').delay(2000).fadeOut('slow');
        }
        else if(answer == "")
        {
            $('#AnswerErrorMsg').html("Enter Your Security Questions Answer");
            $('#AnswerErrorMsg').show();
            $('#answer').focus();
            $('#AnswerErrorMsg').delay(2000).fadeOut('slow');
        }
        else
        {
            var enteredAnswer = $('#answer').val();
            if(answerForm.toLowerCase() == enteredAnswer.toLowerCase())
            {
                $('#AnswerErrorMsg').html("Please Wait..");
                $('#AnswerErrorMsg').show();
                $('#AnswerErrorMsg').delay(3000).fadeOut('slow');
                $('#submit_button').hide();
                $.ajax({
                    type: 'POST',
                    url : "{% url 'update_password' %}",
                    data : $('#forgot_password_form').serialize(),
                    success: function(data)
                    {
                        $('#sucessMsg').show();
                        $('#sucessMsg').delay(2000).fadeOut('slow');
                        $('#submit_button').show();
                        setTimeout('location.reload()',3000);
                    }
                });
            }
            else
            {
                $('#AnswerErrorMsg').html("The answer you entered does not match your previous answer, please verify and try again else contact administrator");
                $('#AnswerErrorMsg').show();
                $('#AnswerErrorMsg').delay(2000).fadeOut('slow');
            }
        }
    }

    function validateemailId(emailId)
    {
        var pattern=/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/;
        var no=emailId.match(pattern);

        if(no==null)
        {
            $('#emailErrorMsg').html("<span class='alert alert-danger'>The email Id is Not valid");
            $('#email').val("");
            $('#emailErrorMsg').show();
            $('#emailErrorMsg').delay(2000).fadeOut('slow');
        }else{
         $('#emailErrorMsg').hide();
        }

    }

    function getSecurityQuestion(uid)
     {
        if(uid == "")
        {
            $('#emailErrorMsg').html("Email Is Required.");
            $('#emailErrorMsg').show();
            $('#emailErrorMsg').delay(2000).fadeOut('slow');
        }
        else
        {
            $.ajax({
                type : "GET",
                url : "{% url 'load_security_question' %}",
                data :{'email':uid},
                success : function(data)
                {
                    $('#security').html(data);
                }
            });
        }
     }

    function getAnswer(questionId)
    {
        var uid = $('#email').val();
        $.ajax({
            async: false,
            type: 'POST',
            url : "{% url 'get_security_answer' %}",
            data :{'questionId':questionId, 'email':uid,  csrfmiddlewaretoken: '{{ csrf_token }}'},
            success: function(data)
            {
                $('#securityAnswer').val(data.answer);
            }
        });
    }
</script>